name: Test All Algorithm Solutions

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  detect-tasks:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      has-tasks: ${{ steps.detect.outputs.has-tasks }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Detect tasks and languages
      id: detect
      run: |
        # Find all task-language combinations
        MATRIX_JSON="[]"
        HAS_TASKS=false
        
        for task_dir in */; do
          task_name=${task_dir%/}
          # Skip hidden directories and non-task directories
          if [[ $task_name == .* ]] || [[ ! -d "$task_name" ]]; then
            continue
          fi
          
          # Check for language subdirectories
          for lang in go python java cpp; do
            if [[ -d "$task_name/$lang" ]]; then
              # Build JSON manually to avoid jq dependency issues
              if [[ "$MATRIX_JSON" == "[]" ]]; then
                MATRIX_JSON="[{\"task\": \"$task_name\", \"lang\": \"$lang\"}]"
              else
                # Remove the closing bracket and add new entry
                MATRIX_JSON="${MATRIX_JSON%]}, {\"task\": \"$task_name\", \"lang\": \"$lang\"}]"
              fi
              HAS_TASKS=true
            fi
          done
        done
        
        echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
        echo "has-tasks=$HAS_TASKS" >> $GITHUB_OUTPUT
        echo "Detected task-language combinations:"
        echo "$MATRIX_JSON"

  test-solutions:
    needs: detect-tasks
    if: needs.detect-tasks.outputs.has-tasks == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.detect-tasks.outputs.matrix) }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      if: matrix.lang == 'go'
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: true
        cache-dependency-path: go.sum

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Set up Java
      if: matrix.lang == 'java'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Set up C++
      if: matrix.lang == 'cpp'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Install Python dependencies
      run: |
                python -m venv .venv
                source .venv/bin/activate
                python -m pip install --upgrade pip
                pip install -U fmi-ai-judge

    - name: Build solution for ${{ matrix.task }} (${{ matrix.lang }})
      run: make build TASK=${{ matrix.task }} LANGUAGE=${{ matrix.lang }}

    - name: Test correctness for ${{ matrix.task }} (${{ matrix.lang }})
      run: make test TASK=${{ matrix.task }} LANGUAGE=${{ matrix.lang }}

    - name: Display test results
      if: always()
      run: |
        echo "## Test Results for ${{ matrix.task }} (${{ matrix.lang }})" >> $GITHUB_STEP_SUMMARY
        if [ -f "${{ matrix.task }}/.judge/results.csv" ]; then
          echo "### CSV Results:" >> $GITHUB_STEP_SUMMARY
          echo '```csv' >> $GITHUB_STEP_SUMMARY
          cat "${{ matrix.task }}/.judge/results.csv" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Also output to console for immediate visibility
          echo "=== Test Results for ${{ matrix.task }} (${{ matrix.lang }}) ==="
          cat "${{ matrix.task }}/.judge/results.csv"
          echo "================================================================"
          
          # Check for failures and provide summary
          if grep -q "TLE\|WA\|RE" "${{ matrix.task }}/.judge/results.csv"; then
            echo "⚠️ Some tests failed - see details above" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Some tests failed for ${{ matrix.task }} (${{ matrix.lang }})"
          else
            echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "No judge results found for ${{ matrix.task }} (${{ matrix.lang }})" >> $GITHUB_STEP_SUMMARY
        fi

